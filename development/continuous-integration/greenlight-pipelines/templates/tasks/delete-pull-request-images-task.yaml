apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: delete-pull-request-images
  namespace: greenlight-pipelines
spec:
  description: >-
    Removes preview application image tags generated from pull request builds.
  workspaces:
    - name: node-modules
      description: modules with useful shared behavior
  params:
    - name: node-image
      description: Base Node.js image to use for the build
      default: greenlightcoop/node-utils:0.1.24@sha256:ba9cf4e4985824c39ef671fcd04c7413391dd12b81320a99906d5ac737a42e5a
    - name: docker-hub-domain
      description: Docker Hub API
      default: hub.docker.com
    - name: organization
      description: the Docker Hub organization name
    - name: repository
      description: the repository name, also used as the Docker image name
    - name: pull-request-number
      description: GitHub pull request number
      default: n/a
  steps:
    - name: delete-pull-request-images
      image: $(params.node-image)
      script: |
        #!/usr/bin/env node
        
        const { DockerHubApi, getDockerCredentials } = require('@greenlight-coop/greenlight-build-utils')

        const domain = '$(params.docker-hub-domain)'
        const dockerHubUrl = `https://${domain}/v2/`

        const organization = '$(params.organization)'
        const repository = '$(params.repository)'
        const pullRequestNumber = '$(params.pull-request-number)'

        async function deletePullRequestImages () {
          try {
            const auth = await getDockerCredentials(dockerHubUrl)
            const properties = {
              domain,
              organization,
              repository,
              username: auth.username,
              password: auth.password
            }
            const api = new DockerHubApi(properties)

            const tags = await api.getPullRequestTags(pullRequestNumber)
            for (const tag of tags) {
              await api.deleteTag(tag)
            }
          } catch (err) {
            console.log(err)
            throw err
          }
        }
        
        deletePullRequestImages()
