apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: snyk-monitor
spec:
  description: >-
    Sets up Snyk monitoring on project assets.
  params:
    - name: image
      description: Tag of image in Docker Hub to assess.
      type: string
  workspaces:
    - name: source
  steps:
    - name: snyk-monitor
      image: greenlightcoop/snyk-tools:0.1.2@sha256:02acc4110fa0415738679c760073000004252b0e21a7b91dec9653961113a522
      workingDir: $(workspaces.source.path)
      env:
        - name: SNYK_TOKEN
          valueFrom:
            secretKeyRef:
              name: snyk
              key: token
      script: |
        #!/usr/bin/env bash
        set -ex
        snyk config set org=greenlight
        snyk config set disableSuggestions=true
        if [ -f "$(workspaces.source.path)/package.json" ] 
        then
          snyk monitor
        else
          echo 'No package.json, skipping snyk monitor'
        fi
        snyk container monitor $(params.image) --file=$(workspaces.source.path)/Dockerfile