apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: wait-for-stage-ready
spec:
  description: >-
    Waits for deployment to a stage to complete.
  params:
    - name: namespace
      description: The namespace the stage is deployed in.
      type: string
    - name: kubectl-image
      default: gcr.io/cloud-builders/kubectl@sha256:253bbf752b78f904c1c9e9faed77526532f9d177ba9e50ca7d03cd1cfba6996f #image is huge
      description: Kubectl wrapper image
  steps:
    - name: wait-for-stage-ready
      image: $(params.kubectl-image)
      script: |
        #!/usr/bin/env bash
        set -ex

        while : ; do
          COUNT=$(kubectl -n $(params.namespace) get services.serving.knative.dev -o jsonpath='{.items[*].metadata.name}' | wc -w)
          if [ "$COUNT" -gt "0" ]; then break; fi
          sleep 5
        done

        for ksvc in `kubectl -n $(params.namespace) get services.serving.knative.dev -o jsonpath='{.items[*].metadata.name}'`
        do 
          kubectl wait -n $(params.namespace) --for=condition=Ready --timeout=240s ksvc/$ksvc
        done